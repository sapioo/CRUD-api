<!DOCTYPE html>
<html>
  <head>
    <title>Basic Task App</title>
  </head>
  <body>
    <h1>My Tasks</h1>

    <form id="task-form">
      <h3>Add a New Task</h3>
      <label>Title:</label>
      <br />
      <input type="text" id="task-title-input" required />
      <br />

      <label>Description:</label>
      <br />
      <textarea id="task-description-input"></textarea>
      <br />

      <label>Due Date:</label>
      <br />
      <input type="date" id="task-dueDate-input" />
      <br />

      <label>Status:</label>
      <br />
      <select id="task-status-input">
        <option value="pending">Pending</option>
        <option value="in-progress">In Progress</option>
        <option value="completed">Completed</option>
      </select>
      <br /><br />

      <button type="submit">Save New Task</button>
    </form>

    <hr />

    <h2>Task List</h2>
    <div id="task-list-container"></div>

    <script>
      // --- Configuration ---
      const API_URL = "http://localhost:5000/api/tasks";

      // --- Getting references to HTML elements ---
      const taskForm = document.getElementById("task-form");
      const titleInput = document.getElementById("task-title-input");
      const descriptionInput = document.getElementById(
        "task-description-input"
      );
      const dueDateInput = document.getElementById("task-dueDate-input"); // NEW
      const statusInput = document.getElementById("task-status-input"); // NEW
      const taskListContainer = document.getElementById("task-list-container");

      // --- Function to get all tasks from the API and display them ---
      function getAndShowAllTasks() {
        taskListContainer.innerHTML = "";

        fetch(API_URL)
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            const tasks = data.data.tasks;

            if (tasks.length === 0) {
              taskListContainer.innerHTML = "<p>You have no tasks!</p>";
            } else {
              tasks.forEach(function (task) {
                const taskElement = document.createElement("div");

                // NEW: Format the due date for display
                let formattedDueDate = "Not set";
                if (task.dueDate) {
                  formattedDueDate = new Date(
                    task.dueDate
                  ).toLocaleDateString();
                }

                // UPDATED: Display now includes status and due date
                taskElement.innerHTML = `
                                <h4>${task.title}</h4>
                                <p>${task.description || "No description"}</p>
                                <p><b>Status:</b> ${task.status}</p>
                                <p><b>Due Date:</b> ${formattedDueDate}</p>
                                <button data-id="${
                                  task._id
                                }" class="delete-button">Delete</button>
                                <hr>
                            `;

                taskListContainer.appendChild(taskElement);
              });
            }
          })
          .catch(function (error) {
            console.error("Error fetching tasks:", error);
            taskListContainer.innerHTML =
              "<p>Could not load tasks. Is the server running?</p>";
          });
      }

      // --- Event Listener for the form submission ---
      taskForm.addEventListener("submit", function (event) {
        event.preventDefault();

        // UPDATED: Create an object with all the data from the form
        const newTask = {
          title: titleInput.value,
          description: descriptionInput.value,
          dueDate: dueDateInput.value || null, // Send null if empty
          status: statusInput.value,
        };

        fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(newTask),
        })
          .then(function (response) {
            if (response.ok) {
              taskForm.reset(); // This clears all form fields
              getAndShowAllTasks();
            } else {
              alert("Failed to create task.");
            }
          })
          .catch(function (error) {
            console.error("Error creating task:", error);
            alert("An error occurred.");
          });
      });

      // --- Event Listener for Delete Buttons ---
      taskListContainer.addEventListener("click", function (event) {
        if (event.target.classList.contains("delete-button")) {
          const taskIdToDelete = event.target.getAttribute("data-id");

          fetch(`${API_URL}/${taskIdToDelete}`, { method: "DELETE" })
            .then(function (response) {
              if (response.ok) {
                getAndShowAllTasks();
              } else {
                alert("Failed to delete task.");
              }
            })
            .catch(function (error) {
              console.error("Error deleting task:", error);
              alert("An error occurred.");
            });
        }
      });

      // --- Initial Load ---
      getAndShowAllTasks();
    </script>
  </body>
</html>
